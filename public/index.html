<!doctype html>
<html lang="en">

<head>
    <title>Hangman</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"
        integrity="sha512-5A8nwdMOWrSz20fDsjczgUidUBR8liPYU+WymTZP1lmY9G6Oc7HlZv156XqnsgNUzTyMefFTcsFH/tnJE/+xBg=="
        crossorigin="anonymous" />
    <style>
        .actions {
            text-align: center;
        }

        .actions>* {
            margin: 2px;
        }

        #apiCallResponse {
            border: 1px solid lightgray;
            width: 100%;
            height: 120px;
            max-height: 120px;
            overflow: scroll;
            padding: 4px;
            font-family: monospace;
            font-size: 9pt;
        }

        #logs {
            border: 1px solid lightgray;
            width: 100%;
            max-height: 200px;
            height: 200px;
            resize: none;
            overflow: scroll;
            white-space: nowrap;
            padding: 4px;
            font-family: monospace;
            font-size: 9pt;
        }
    </style>
</head>

<body>

    <div class="container-fluid">
        <h4 class="text-center">Single Page App</h4>

        <div class="actions">
            <button class="btn btn-secondary" id="classicLogin">Login</button>
            <button class="btn btn-secondary" id="classicLogout">Logout</button>
            <button class="btn btn-warning" id="apiCall">API Call</button>
            <button class="btn btn-secondary" id="clearLogs"><span class="fa fa-trash"></span></button>
        </div>

        <pre id="apiCallResponse"></pre>
        <textarea id="logs"></textarea>
    </div>


    <!-- https://firebase.google.com/docs/web/setup#from-the-cdn -->
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.3.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.3/firebase-auth.js"></script>

    <script>
        let lastAuthenticatedUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            document.getElementById('classicLogin').addEventListener('click', classicLogin);
            document.getElementById('classicLogout').addEventListener('click', classicLogout);
            document.getElementById('apiCall').addEventListener('click', callApi);
            document.getElementById('clearLogs').addEventListener('click', clearLogs);

            window.addEventListener('message', handleMessage);
        });

        function initFirebase() {
            // Your web app's Firebase configuration
            const firebaseConfig = {
                apiKey: 'AIzaSyB4FUVEG5DzSclgXGJeEo9tmq9MlBeSxQM',
                authDomain: 'nativefirebase2webview.firebaseapp.com',
                projectId: 'nativefirebase2webview',
                storageBucket: 'nativefirebase2webview.appspot.com',
                messagingSenderId: '467182013316',
                appId: '1:467182013316:web:edc1802f2f3df452b8ebd1'
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE);
            log(`Firebase initialized`);
        }

        function classicLogin() {
            log(`Calling firebase.auth().signInWithEmailAndPassword...`);

            firebase
                .auth()
                .signInWithEmailAndPassword('jane.doe@example.com', 'SuperSecretPassword!')
                .then(({ user }) => {
                    lastAuthenticatedUser = user;
                    log(`refreshToken: ${user.refreshToken}`);
                    log(`lastAuthenticatedUser: ${JSON.stringify(lastAuthenticatedUser)}`);
                    log(user.email + ' - ' + user.uid);
                });
        }

        async function classicLogout() {
            log(`Calling firebase.auth().signOut...`);
            await firebase.auth().signOut();
            log('Logout completed.');

            document.getElementById('apiCallResponse').innerHTML = '';
            lastAuthenticatedUser = null;
        }

        async function callApi() {
            document.getElementById('apiCallResponse').innerHTML = '';

            const headers = {
                'Content-Type': 'application/json',
            };

            if (lastAuthenticatedUser) {
                const token = await lastAuthenticatedUser.getIdToken(true);
                headers['Authorization'] = `Bearer ${token}`;
            }

            const url = '/api/v1/about';
            log(`Calling ${url}`);
            const response = await fetch('/api/v1/about', { headers });
            log(`Calling ${url} statusCode: ${response.status} - ${response.statusText}`);
            const data = await response.json();

            document.getElementById('apiCallResponse').innerHTML = JSON.stringify(data, null, 2);
        }

        function log(info) {
            const logs = document.getElementById('logs');
            const lines = logs.value;
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            const newLine = `${timestamp} ${info}`;
            logs.value = newLine + '\n' + lines;
        }

        function clearLogs() {
            document.getElementById('apiCallResponse').innerHTML = '';
            document.getElementById('logs').value = '';
        }

        async function customTokenLogin(customToken) {
            log(`calling signInWithCustomToken with ${customToken}`);
            const { user } = await firebase.auth().signInWithCustomToken(customToken);

            lastAuthenticatedUser = user;
            log(`refreshToken: ${user.refreshToken}`);
            log(user.email + ' - ' + user.uid);

            log('Calling API with that new token...');
            callApi();
        }

        // ********************************************************************************************************
        // Communication bridge between SPA (webapp) & Webview (native)
        // ********************************************************************************************************
        async function postMessageToWebView(type, data) {
            if (window && window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({ type, data }));
                return true;
            }

            log(`ReactNativeWebView not available for sending [${type}] message`);
            return false;
        };

        async function handleMessage(event) {
            const { type, data } = event.data;

            if (type) {
                log(`SPA received a message: \n${type}`);
            }

            switch (type) {
                case 'customToken':
                    customTokenLogin(data);
                    break;

                default:
                    break;
            }
        }
    </script>

</body>

</html>